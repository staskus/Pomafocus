default_platform(:ios)

require 'dotenv'
Dotenv.load('../.env')

# Helper to require environment variables
def require_env(name)
  value = ENV[name]
  UI.user_error!("Missing required environment variable: #{name}\nPlease create apps/ios/.env from .env.example") if value.nil? || value.empty?
  value
end

# Load configuration from environment
def config
  @config ||= begin
    prefix = require_env('BUNDLE_ID_PREFIX')
    {
      team_id: require_env('TEAM_ID'),
      apple_id: require_env('APPLE_ID'),
      app_group: require_env('APP_GROUP_ID'),
      icloud_container: require_env('ICLOUD_CONTAINER_ID'),
      bundle_ids: {
        main: "#{prefix}.ios",
        widgets: "#{prefix}.ios.homewidgets",
        activities: "#{prefix}.ios.activities",
        shield: "#{prefix}.ios.shield"
      }
    }
  end
end

platform :ios do
  desc "Get or create iOS development certificate"
  lane :setup_certificates do
    get_certificates(
      development: true,
      username: config[:apple_id],
      team_id: config[:team_id],
      keychain_path: File.expand_path("~/Library/Keychains/login.keychain-db")
    )
    get_certificates(
      development: false,
      username: config[:apple_id],
      team_id: config[:team_id],
      keychain_path: File.expand_path("~/Library/Keychains/login.keychain-db")
    )
    UI.success("Certificates ready")
  end

  desc "Register App Group in Developer Portal"
  lane :register_app_group do
    require 'spaceship'

    Spaceship::Portal.login(config[:apple_id])
    Spaceship::Portal.client.team_id = config[:team_id]

    group_id = config[:app_group]
    existing = Spaceship::Portal.app_group.find(group_id)

    if existing
      UI.success("App Group already exists: #{group_id}")
    else
      Spaceship::Portal.app_group.create!(group_id: group_id, name: "Pomafocus")
      UI.success("App Group registered: #{group_id}")
    end
  end

  desc "Register all App IDs with capabilities"
  lane :register_app_ids do
    ids = config[:bundle_ids]

    # Main app with full capabilities
    produce(
      username: config[:apple_id],
      app_identifier: ids[:main],
      app_name: "Pomafocus",
      skip_itc: true,
      enable_services: {
        push_notification: "on",
        icloud: "cloudkit",
        app_group: "on",
        family_controls: "on"
      }
    )
    UI.success("Registered: #{ids[:main]}")

    # Home Widgets with App Groups
    produce(
      username: config[:apple_id],
      app_identifier: ids[:widgets],
      app_name: "Pomafocus Home Widgets",
      skip_itc: true,
      enable_services: {
        app_group: "on"
      }
    )
    UI.success("Registered: #{ids[:widgets]}")

    # Activities (no special capabilities)
    produce(
      username: config[:apple_id],
      app_identifier: ids[:activities],
      app_name: "Pomafocus Activities",
      skip_itc: true
    )
    UI.success("Registered: #{ids[:activities]}")

    # Shield (Family Controls for ManagedSettings)
    produce(
      username: config[:apple_id],
      app_identifier: ids[:shield],
      app_name: "Pomafocus Shield",
      skip_itc: true,
      enable_services: {
        family_controls: "on"
      }
    )
    UI.success("Registered: #{ids[:shield]}")
  end

  desc "Associate App Group with App IDs"
  lane :associate_app_groups do
    require 'spaceship'

    Spaceship::Portal.login(config[:apple_id])
    Spaceship::Portal.client.team_id = config[:team_id]

    ids = config[:bundle_ids]
    group_id = config[:app_group]

    [ids[:main], ids[:widgets]].each do |app_id|
      app = Spaceship::Portal.app.find(app_id)
      if app
        app.update_service(Spaceship::Portal.app_service.app_group.on)
        group = Spaceship::Portal.app_group.find(group_id)
        if group
          app.associate_groups([group])
          UI.success("Associated #{group_id} with #{app_id}")
        else
          UI.error("App Group not found: #{group_id}")
        end
      else
        UI.error("App ID not found: #{app_id}")
      end
    end
  end

  desc "Generate and download provisioning profiles"
  lane :setup_profiles do
    ids = config[:bundle_ids]
    team = config[:team_id]
    # Let sigh choose any valid certificate from the keychain.
    ENV.delete("SIGH_CERTIFICATE_ID")
    ENV.delete("SIGH_CERTIFICATE_NAME")

    # Main app - needs App Groups
    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:main],
      development: true,
      force: true,
      team_id: team,
      filename: "Pomafocus_Development.mobileprovision",
      output_path: "./profiles"
    )
    UI.success("Profile for main app: #{ids[:main]}")

    # Widgets - needs App Groups
    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:widgets],
      development: true,
      force: true,
      team_id: team,
      filename: "PomafocusHomeWidgets_Development.mobileprovision",
      output_path: "./profiles"
    )
    UI.success("Profile for widgets: #{ids[:widgets]}")

    # Activities - no special entitlements
    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:activities],
      development: true,
      force: true,
      team_id: team,
      filename: "PomafocusActivities_Development.mobileprovision",
      output_path: "./profiles"
    )
    UI.success("Profile for activities: #{ids[:activities]}")

    # Shield - needs Family Controls
    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:shield],
      development: true,
      force: true,
      team_id: team,
      filename: "PomafocusShield_Development.mobileprovision",
      output_path: "./profiles"
    )
    UI.success("Profile for shield: #{ids[:shield]}")

    # Ad-hoc profiles for OTA builds
    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:main],
      adhoc: true,
      force: true,
      team_id: team,
      filename: "Pomafocus_AdHoc.mobileprovision",
      output_path: "./profiles",
      provisioning_name: "#{ids[:main]} Ad Hoc"
    )
    UI.success("Ad-hoc profile for main app: #{ids[:main]}")

    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:widgets],
      adhoc: true,
      force: true,
      team_id: team,
      filename: "PomafocusHomeWidgets_AdHoc.mobileprovision",
      output_path: "./profiles",
      provisioning_name: "#{ids[:widgets]} Ad Hoc"
    )
    UI.success("Ad-hoc profile for widgets: #{ids[:widgets]}")

    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:activities],
      adhoc: true,
      force: true,
      team_id: team,
      filename: "PomafocusActivities_AdHoc.mobileprovision",
      output_path: "./profiles",
      provisioning_name: "#{ids[:activities]} Ad Hoc"
    )
    UI.success("Ad-hoc profile for activities: #{ids[:activities]}")

    get_provisioning_profile(
      username: config[:apple_id],
      app_identifier: ids[:shield],
      adhoc: true,
      force: true,
      team_id: team,
      filename: "PomafocusShield_AdHoc.mobileprovision",
      output_path: "./profiles",
      provisioning_name: "#{ids[:shield]} Ad Hoc"
    )
    UI.success("Ad-hoc profile for shield: #{ids[:shield]}")

    # Install profiles
    install_provisioning_profile(path: "./profiles/Pomafocus_Development.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusHomeWidgets_Development.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusActivities_Development.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusShield_Development.mobileprovision")
    install_provisioning_profile(path: "./profiles/Pomafocus_AdHoc.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusHomeWidgets_AdHoc.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusActivities_AdHoc.mobileprovision")
    install_provisioning_profile(path: "./profiles/PomafocusShield_AdHoc.mobileprovision")

    UI.success("All profiles installed")
  end

  desc "Full signing setup - certificates, app IDs, profiles"
  lane :setup_signing do
    UI.header("Setting up Pomafocus signing...")
    UI.message("Apple ID: #{config[:apple_id]}")
    UI.message("Team ID: #{config[:team_id]}")
    UI.message("")

    # Create profiles directory
    FileUtils.mkdir_p("./profiles")

    # Step 1: Get development certificate
    UI.message("Step 1/5: Setting up certificates...")
    setup_certificates

    # Step 2: Register App Group
    UI.message("Step 2/5: Registering App Group...")
    register_app_group

    # Step 3: Register App IDs
    UI.message("Step 3/5: Registering App IDs...")
    register_app_ids

    # Step 4: Associate App Groups
    UI.message("Step 4/5: Associating App Groups...")
    associate_app_groups

    # Step 5: Generate and install profiles
    UI.message("Step 5/5: Generating provisioning profiles...")
    setup_profiles

    UI.success("")
    UI.success("=" * 50)
    UI.success("Signing setup complete!")
    UI.success("=" * 50)
    UI.success("")
    UI.success("Next steps:")
    UI.success("1. Run: ./Scripts/generate_ios_project.sh")
    UI.success("2. Open Xcode and build")
  end
end
